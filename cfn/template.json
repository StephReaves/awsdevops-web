{
  "AWSTemplateFormatVersion":"2010-09-09",
  "Description": "Cross Region Scalable, ECS Cloud Formation Template",
  "Metadata": {
    "Author": {"Name": "J Cole Morrison"}
  },
  "Parameters": {
    "WebTaskImage": {
      "Type": "String",
      "Description": "Url of the Docker Image to deploy"
    },
    "VpcId": {
      "Type":"AWS::EC2::VPC::Id",
      "Description":"Select a VPC that allows instances to access the Internet."
    },
    "BastionSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup::Id",
      "Description": "Security Group ID of our Bastion Server"
    }
  },
  "Mappings": {
    "AWSRegionECSAMI":{
      "us-east-1": { "ID" : "ami-275ffe31" },
      "us-east-2": { "ID" : "ami-62745007" },
      "us-west-1": { "ID" : "ami-689bc208" },
      "us-west-2": { "ID" : "ami-62d35c02" },
      "eu-west-1": { "ID" : "ami-95f8d2f3" },
      "eu-west-2": { "ID" : "ami-bf9481db" },
      "eu-central-1": { "ID" : "ami-085e8a67" },
      "ap-northeast-1": { "ID" : "ami-f63f6f91" },
      "ap-southeast-1": { "ID" : "ami-b4ae1dd7" },
      "ap-southeast-2": { "ID" : "ami-fbe9eb98" },
      "ca-central-1": { "ID" : "ami-ee58e58a" }
    }
  },
  "Conditions": {},
  "Resources": {
    "WebCluster": {
      "Type": "AWS::ECS::Cluster"
    },
    "WebALBSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "SecurityGroup for our Web Application Load Balancer",
        "VpcId": {
          "Ref": "VpcId"
        },
        "Tags": [{
          "Key": "Name",
          "Value": "Web ALB Security Group"
        }],
        "SecurityGroupIngress": [
          {
            "IpProtocol":"tcp",
            "FromPort":"80",
            "ToPort":"80",
            "CidrIp":"0.0.0.0/0"
          }
        ]
      }
    },
    "WebInstanceSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "SecurityGroup for our Web Instances",
        "VpcId": {
          "Ref": "VpcId"
        },
        "Tags": [{
          "Key": "Name",
          "Value": "Web Instance Security Group"
        }],
        "SecurityGroupIngress": [
          {
            "IpProtocol":"tcp",
            "FromPort":"22",
            "ToPort":"22",
            "SourceSecurityGroupId": { "Ref": "BastionSecurityGroup" }
          },
          {
            "IpProtocol":"tcp",
            "FromPort":"31000",
            "ToPort":"61000",
            "SourceSecurityGroupId": { "Ref": "WebALBSecurityGroup" }
          }
        ]
      }
    }
  },
  "Outputs": {
    "EcsCluster": {
      "Description": "The name of our newly created cluster",
      "Value": {"Ref": "WebCluster"}
    }
  }
}
